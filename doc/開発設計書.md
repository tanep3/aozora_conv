
# 開発設計書

## 1. システム概要

aozora_conv は、青空文庫形式のテキストファイルを入力として受け取り、制御記号を削除し、作品名および著者名を抽出し、指定された読書速度および時間に基づいてテキストを分割して出力するシェルスクリプトである。

## 2. システム構成

- 入力: 青空文庫形式のテキストファイルまたは標準入力。
- 処理:
  - 文字コードの検出とUTF-8への変換。
  - 説明書きブロックの削除。
  - 作品名および著者名の抽出。
  - 本文の抽出。
  - 制御記号および注釈の削除。
  - 出力内容の整形。
  - テキストの分割（オプション）。
- 出力: 分割されたテキストファイルまたは標準出力。

## 3. モジュール設計

### 3.1 メインモジュール

- 機能: オプションのパース、入力ファイルの処理フローの管理、出力の制御。
- 詳細:
  - オプションの解析。
  - 必要なツールの確認。
  - 入力ファイルの存在確認。
  - 各処理ステップの順次実行。
  - 出力の分割および出力先の決定。

### 3.2 文字コード変換モジュール

- 機能: 入力ファイルの文字コードを検出し、UTF-8に変換する。
- 詳細:
  - nkf を使用して文字コードを検出。
  - UTF-8に変換し、一時ファイルに保存。
  - 変換後の文字コードを標準エラー出力に表示。

### 3.3 説明書きブロック削除モジュール

- 機能: テキスト内の説明書きブロック（連続するハイフンライン）を削除する。
- 詳細:
  - sed を使用して、開始と終了のハイフンライン間を削除。

### 3.4 作品名および著者名抽出モジュール

- 機能: テキストの最初の2行から作品名と著者名を抽出する。
- 詳細:
  - 1行目を作品名、2行目を著者名として抽出し、それ以降の本文を抽出。

### 3.5 本文抽出モジュール

- 機能: 抽出したテキストから本文部分を取得する。
- 詳細:
  - 指定された終了マーカーまでのテキストを本文として抽出。

### 3.6 制御記号および注釈削除モジュール

- 機能: テキスト内の指定された制御記号および注釈を削除する。
- 詳細:
  - sed を使用して、特定のパターンを削除。
  - 「」で囲まれた部分は保持する。

### 3.7 出力整形モジュール

- 機能: 作品名、著者名、本文を整形して最終出力ファイルを作成する。
- 詳細:
  - 作品名と著者名を先頭に配置し、本文を続ける。

### 3.8 分割モジュール

- 機能: 指定された読書スピードおよび時間に基づいてテキストを分割する。
- 詳細:
  - 総文字数を計算し、分割文字数に達した時点で改行位置で分割。
  - 分割ファイルにナンバリングを付与して出力。
  - 分割時間が指定されていない場合、標準出力または1本のファイルに出力。

## 4. データフロー図

入力ファイルまたは標準入力  
     ↓  
文字コード変換 (UTF-8)  
     ↓  
説明書きブロック削除  
     ↓  
作品名・著者名抽出  
     ↓  
本文抽出  
     ↓  
制御記号および注釈削除  
     ↓  
出力整形  
     ↓  
分割（オプション）  
     ↓  
出力ファイルまたは標準出力  

## 5. ユーザーインターフェース

- コマンドラインインターフェース（CLI）
  - オプション:
    - -h, --help: ヘルプメッセージの表示。
    - -s, --speed NUM: 読書スピード（1分間にNUM文字）の指定。デフォルトは300。
    - -t, --time MINUTES: 分割時間（分単位）の指定。デフォルトは20分。
    - -i, --input FILE: 入力ファイルの指定。複数指定可能。
    - -o, --output FILE: 出力ファイルの指定。

## 6. エラーハンドリング

- 入力ファイルが存在しない場合、エラーメッセージを標準エラー出力に表示し、処理を中断する。
- -s または -t オプションを -o オプションなしで使用した場合、エラーメッセージを表示し処理を中断する。
- 不明なオプションが指定された場合、エラーメッセージを表示し処理を中断する。

## 7. テスト計画

- ユニットテスト:
  - 各モジュール（文字コード変換、制御記号削除など）が正しく機能するかを確認。
- 統合テスト:
  - 全体のフローが正しく動作し、指定されたオプションに基づいて適切に出力が行われるかを確認。
- エラーテスト:
  - 存在しないファイルを指定した場合のエラーハンドリングを確認。
  - 不正なオプションの組み合わせを指定した場合のエラーハンドリングを確認。
- パフォーマンステスト:
  - 大規模なテキストファイルを処理した際のパフォーマンスを評価。

## 8. 保守性

- スクリプトは明確なコメントとモジュール化された関数により、将来的な機能追加や修正が容易に行えるよう設計する。

## 9. 開発環境

- OS: POSIX互換のシェル環境（例: Linux, macOS）
- ツール: bash, nkf, sed, grep, gawk, mktemp, tr, head, sort, uniq, wc

## 10. スケジュール

- 要件定義: 完了
- 設計: 完了
- 実装: 実装済み
- テスト: 今後実施
- リリース: テスト完了後
